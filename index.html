<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>비밀번호 재설정</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(
          180deg,
          #7a5e4f 0%,
          #9b8070 50%,
          #b89a7f 80%
        );
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        position: relative;
        overflow: hidden;
      }
      body::before {
        content: "";
        position: absolute;
        width: 85%;
        height: 70%;
        right: -20%;
        bottom: -20%;
        background: radial-gradient(
          circle,
          rgba(255, 122, 61, 1) 0%,
          rgba(255, 153, 85, 0.9) 35%,
          rgba(245, 168, 105, 0.7) 65%,
          rgba(229, 168, 105, 0.5) 75%,
          rgba(200, 155, 109, 0.3) 85%,
          rgba(184, 154, 127, 0.1) 95%,
          transparent 100%
        );
        border-radius: 50%;
        pointer-events: none;
      }
      .container {
        background: rgba(240, 240, 243, 0.95);
        border-radius: 16px;
        padding: 32px;
        max-width: 400px;
        width: 100%;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1), 0 8px 12px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 1;
      }
      h2 {
        color: #1a1a1a;
        margin-bottom: 8px;
        font-size: 32px;
        font-weight: 700;
        text-align: center;
      }
      .subtitle {
        color: rgba(0, 0, 0, 0.9);
        margin-bottom: 24px;
        font-size: 18px;
        font-weight: 500;
        text-align: center;
      }
      #loading {
        text-align: center;
        color: rgba(0, 0, 0, 0.9);
        padding: 20px;
        font-size: 15px;
      }
      #form {
        display: none;
      }
      .input-container {
        margin-bottom: 16px;
      }
      .label {
        font-size: 15px;
        font-weight: 500;
        color: #1a1a1a;
        margin-bottom: 8px;
      }
      input {
        width: 100%;
        padding: 12px;
        margin-top: 0;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        font-size: 15px;
        background: #ffffff;
        color: #1a1a1a;
      }
      input::placeholder {
        color: rgba(0, 0, 0, 0.5);
      }
      input:focus {
        outline: none;
        border-color: #ff6b35;
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
      }
      button {
        width: 100%;
        padding: 12px;
        margin-top: 12px;
        background: #ff6b35;
        color: #ffffff;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      button:hover {
        background: #ff8c42;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15),
          0 6px 12px rgba(0, 0, 0, 0.15);
      }
      button:active {
        transform: translateY(0);
      }
      button:disabled {
        background: rgba(0, 0, 0, 0.2);
        cursor: not-allowed;
        opacity: 0.6;
        transform: none;
      }
      #done {
        display: none;
        text-align: center;
        color: #34c759;
        padding: 20px;
        background: rgba(52, 199, 89, 0.1);
        border-radius: 12px;
        margin-top: 20px;
        font-size: 15px;
      }
      .error {
        color: #ff3b30;
        margin-top: 10px;
        font-size: 14px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>비밀번호 재설정</h2>
      <p class="subtitle">새로운 비밀번호를 입력해주세요</p>

      <div id="loading">인증 확인 중...</div>

      <div id="form">
        <div class="input-container">
          <label class="label" for="password">새 비밀번호</label>
          <input
            id="password"
            type="password"
            placeholder="새 비밀번호를 입력하세요"
            minlength="6"
          />
        </div>
        <div id="error" class="error"></div>
        <button onclick="updatePassword()" id="submitBtn">비밀번호 변경</button>
      </div>

      <div id="done">
        ✅ 비밀번호가 변경되었습니다.<br />
        앱으로 돌아가 로그인해주세요.
      </div>
    </div>

    <script>
      // Supabase 라이브러리 로딩 대기 함수
      function waitForSupabase(callback) {
        if (typeof supabase !== "undefined") {
          callback();
        } else {
          setTimeout(() => waitForSupabase(callback), 100);
        }
      }

      // DOM이 로드된 후 실행
      document.addEventListener("DOMContentLoaded", function () {
        const supabaseUrl = "https://vaimrrkggrqxtessqmmw.supabase.co";
        const supabaseKey =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhaW1ycmtnZ3JxeHRlc3NxbW13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MjM3MDEsImV4cCI6MjA4MDQ5OTcwMX0.hqZYUsWVrzg_Rh4VIZcpZPkw3zW5H_LmohccGX0DeqM";

        // Supabase 라이브러리 로딩 대기
        waitForSupabase(function () {
          if (!supabaseUrl || supabaseUrl === "YOUR_SUPABASE_URL") {
            document.getElementById("loading").innerHTML =
              "❌ Supabase URL이 설정되지 않았습니다.";
            document.getElementById("loading").style.color = "#f44336";
          } else {
            console.log("Supabase 초기화:", {
              supabaseUrl,
              supabaseKey: supabaseKey.substring(0, 20) + "...",
            });
            // 전역 supabase 객체를 사용하여 클라이언트 생성
            const supabaseClient = supabase.createClient(
              supabaseUrl,
              supabaseKey
            );

            supabaseClient.auth.onAuthStateChange((event, session) => {
              console.log("Auth state change:", event, session);
              if (event === "PASSWORD_RECOVERY") {
                document.getElementById("loading").style.display = "none";
                document.getElementById("form").style.display = "block";
              }
            });

            // 페이지 로드 시 세션 확인
            supabaseClient.auth.getSession().then(({ data: { session } }) => {
              if (session) {
                // 이미 세션이 있으면 PASSWORD_RECOVERY 상태일 수 있음
                document.getElementById("loading").style.display = "none";
                document.getElementById("form").style.display = "block";
              }
            });

            async function updatePassword() {
              const passwordInput = document.getElementById("password");
              const errorDiv = document.getElementById("error");
              const submitBtn = document.getElementById("submitBtn");
              const password = passwordInput.value.trim();

              // 유효성 검사
              if (!password) {
                errorDiv.textContent = "비밀번호를 입력해주세요.";
                errorDiv.style.display = "block";
                return;
              }

              if (password.length < 6) {
                errorDiv.textContent = "비밀번호는 최소 6자 이상이어야 합니다.";
                errorDiv.style.display = "block";
                return;
              }

              errorDiv.style.display = "none";
              submitBtn.disabled = true;
              submitBtn.textContent = "변경 중...";

              try {
                const { error } = await supabaseClient.auth.updateUser({
                  password,
                });

                if (error) {
                  errorDiv.textContent =
                    error.message || "비밀번호 변경에 실패했습니다.";
                  errorDiv.style.display = "block";
                  submitBtn.disabled = false;
                  submitBtn.textContent = "비밀번호 변경";
                } else {
                  document.getElementById("form").style.display = "none";
                  document.getElementById("done").style.display = "block";
                }
              } catch (error) {
                errorDiv.textContent = "예기치 않은 오류가 발생했습니다.";
                errorDiv.style.display = "block";
                submitBtn.disabled = false;
                submitBtn.textContent = "비밀번호 변경";
              }
            }

            // Enter 키로도 제출 가능
            document
              .getElementById("password")
              .addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                  updatePassword();
                }
              });
          }
        });
      });
    </script>
  </body>
</html>
